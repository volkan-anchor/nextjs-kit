# Full Setup Steps

## Getting Started

```sh
yarn create next-app --typescript
```

## Apollo

### Install dependencies

```sh
yarn add @apollo/client graphql
```

### Create files

```sh
mkdir @types
touch @types/graphql.d.ts
touch pages/TestQuery.js
```

### Add .graphql extension support to nextjs

```js
// next.config.js

/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  webpack: config => {
    config.module.rules.push({
      test: /\.(graphql|gql)$/,
      exclude: /node_modules/,
      loader: 'graphql-tag/loader',
    });
    return config;
  },
  webpackDevMiddleware: config => {
    return config;
  },
};

module.exports = nextConfig;
```

### Add .graphql to ts declarations

```ts
// @types/graphql.d.ts

declare module '*.graphql' {
  import { DocumentNode } from 'graphql';
  const Schema: DocumentNode;

  export = Schema;
}
```

### Update files

```tsx
// ./pages/_app.tsx

import '../styles/globals.css';
import type { AppProps } from 'next/app';
import { ApolloClient, InMemoryCache } from '@apollo/client';
import { ApolloProvider } from '@apollo/client';

const client = new ApolloClient({
  uri: 'https://countries.trevorblades.com',
  cache: new InMemoryCache(),
});

function MyApp({ Component, pageProps }: AppProps) {
  return (
    <ApolloProvider client={client}>
      <Component {...pageProps} />
    </ApolloProvider>
  );
}

export default MyApp;
```

```graphql
# pages/testQuery.js

query ExampleQuery {
  countries {
    code
    name
  }
}
```

```tsx
// pages/index.tsx

import type { NextPage } from 'next';
import Head from 'next/head';
import styles from '../styles/Home.module.css';

import { useQuery } from '@apollo/client';
import TEST_QUERY from './TestQuery.graphql';

const Home: NextPage = () => {
  const { data, loading, error } = useQuery(TEST_QUERY);

  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <h1>Countries</h1>
      <ul>
        {data?.countries.map(country => (
          <li key={country.name}>{country.name}</li>
        ))}
      </ul>
    </div>
  );
};

export default Home;
```

## Prettier

### Installation

```sh
yarn add --dev eslint-config-prettier
```

### Create/Update Configs

```sh
touch .prettierrc.js
```

```js
// .prettierrc.js

module.exports = {
  singleQuote: true,
  trailingComma: 'all',
  arrowParens: 'avoid',
};
```

```json
// .eslintrc.json

{
  "extends": ["prettier", "next/core-web-vitals"],
  "rules": {
    "react-hooks/exhaustive-deps": "off",
    "no-unused-vars": "error"
  }
}
```

### Fix autofixable issues

```sh
npx prettier --write .
```

## Unit Tests

### Dependencies

```bash
yarn add -D jest @testing-library/react @testing-library/jest-dom
```

### Config file

```
touch jest.config.js
touch jest.setup.js
```

```js
// jest.config.js

const nextJest = require('next/jest');

const createJestConfig = nextJest({
  // Provide the path to your Next.js app to load next.config.js and .env files in your test environment
  dir: './',
});

// Add any custom config to be passed to Jest
const customJestConfig = {
  // Add more setup options before each test is run
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  // if using TypeScript with a baseUrl set to the root directory then you need the below for alias' to work
  moduleDirectories: ['node_modules', '<rootDir>/'],
  testEnvironment: 'jest-environment-jsdom',
};

// createJestConfig is exported this way to ensure that next/jest can load the Next.js config which is async
module.exports = createJestConfig(customJestConfig);
```

```js
// jest.setup.js
import '@testing-library/jest-dom/extend-expect';
```

### Aliases (optional)

Add the following to the `tsconfig.json`

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/components/*": ["components/*"]
    }
  }
}
```

And equivalent alias to jest.config.js

```js
moduleNameMapper: {
  '^@/components/(.*)$': '<rootDir>/components/$1',
}
```

### Add Script

Inlcude the following to package.json

```json
{
  "scripts": {
    "test": "jest --watch"
  }
}
```

### Add Tests

```sh
mkdir __tests__
touch __tests__/index.test.jsx
```

```jsx
// __tests__/index.test.jsx

import { render, screen } from '@testing-library/react';
import Home from '../pages/index';

describe('Home', () => {
  it('renders a heading', () => {
    render(<Home />);

    const heading = screen.getByRole('heading', {
      name: /Countries/i,
    });

    expect(heading).toBeInTheDocument();
  });
});
```

## Proxy setup for Graphql and Auth

We need to use NextJS [custom server](https://nextjs.org/docs/advanced-features/custom-server)

This is needed to proxy requests to the proper graphql endpoint and also to handle risk authentication. The code in server.js was copied from setupProxy.js of Risk Dashboard project.
